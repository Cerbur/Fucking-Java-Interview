#   Redis 缓存失效策略

## 缓存雪崩

### 大量缓存同时过期

#### 均匀设置过期时间

给过期时间加上一个随机数，这样不会在同一时间过期

#### 互斥锁

当需要查询数据库时候，上一个互斥锁来确保同一时间只有一个请求构建缓存，同时要设置好互斥锁的过期时间

#### 双 key 策略

主 key 设置过期时间，备 key 不设置过期时间，缓存更新时同时更新主 key 和备 key。

#### 后台更新缓存

让缓存永久有效，并把更新缓存的工作抽离出业务线程，转交给后台线程进行更新。内存紧缺时，缓存会被淘汰。解决方法有，频繁检测缓存是否有效。或者通过消息队列发送通知告知后台线程更新缓存。

### Redis宕机造成缓存雪崩

1. 服务熔断或请求限制机制

   - 我们可以启动服务熔断，暂停业务应用对缓存服务的访问，直接返回错误。
   - 请求限流，只将少部分请求发送到数据库进行处理，再多的请求就在入口直接拒绝。

2. 构建 Redis 高可用集群

   使用主从节点的方式构建 Redis 缓存高可用集群。

## 缓存击穿

热点数据过期，导致缓存失效，大量请求直接访问数据库。

### 互斥锁

一个时间只有一个业务线程更新缓存，未能获取到互斥锁的请求，要么等待锁释放后重新获取缓存，要么放回空或者默认值。

### 不给热点数据设置过期时间

后台异步更新缓存

## 缓存穿透

用户访问的数据，既不在缓存中，也不在数据库中。这样用户请求的时候发现缓存中没有数据，直接访问数据库，然而数据库中也没有数据无法构建缓存，产生大量的请求的这种请求的时候，就会造成数据库压力增加。

### 缓存穿透发生的可能

1. 业务操作失误，不小心删除了
2. 黑客恶意攻击，故意大量访问某些读取不存在的数据业务

### 方案

#### 非法请求限制

#### 缓存空值或者默认值

#### 使用隆过滤器快速判断数据是否存在，避免通过查询数据库来判断数据是否存在

